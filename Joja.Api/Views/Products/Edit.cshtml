@model Joja.Api.Models.Product

@{
    ViewData["Title"] = "Edit Product";
}

<style>
    .drag-drop-zone {
        border: 2px dashed #ccc;
        border-radius: 8px;
        padding: 40px;
        text-align: center;
        cursor: pointer;
        transition: border-color 0.3s;
        margin-bottom: 20px;
        background: #f9f9f9;
        position: relative;
    }
    .drag-drop-zone:hover, .drag-drop-zone.dragover {
        border-color: #B7477E;
        background: #fff;
    }
    .variant-card {
        border: 1px solid #ddd;
        padding: 15px;
        border-radius: 8px;
        margin-bottom: 15px;
        background: #fff;
    }
    .variant-header {
        display: flex;
        justify-content: space-between;
        margin-bottom: 10px;
    }
</style>

<div class="container" style="margin-top: 50px; margin-bottom: 100px;">
    <h1 class="brand-font">Edit Product: @Model.Name</h1>
    <hr />
    
    <form asp-action="Edit" enctype="multipart/form-data" id="editForm">
        <div asp-validation-summary="ModelOnly" class="text-danger"></div>
        <input type="hidden" asp-for="Id" />
        <input type="hidden" asp-for="MainImageUrl" />
        <input type="hidden" asp-for="VideoUrl" />
        <!-- Attributes as JSON -->
        <input type="hidden" asp-for="VariantsJson" id="VariantsJson" />

        <div class="row">
            <!-- Left Column: Basic Info -->
            <div class="col-md-6">
                <div class="card p-4 mb-4 shadow-sm">
                    <h4 class="mb-3">Basic Info</h4>
                    
                    <div class="form-group mb-3">
                        <label asp-for="Name" class="control-label"></label>
                        <input asp-for="Name" class="form-control" />
                        <span asp-validation-for="Name" class="text-danger"></span>
                    </div>

                    <div class="form-group mb-3">
                        <label asp-for="Description" class="control-label"></label>
                        <textarea asp-for="Description" class="form-control" rows="4"></textarea>
                        <span asp-validation-for="Description" class="text-danger"></span>
                    </div>

                    <div class="form-group mb-3">
                        <label asp-for="Price" class="control-label"></label>
                        <input asp-for="Price" class="form-control" type="number" step="0.01" />
                        <span asp-validation-for="Price" class="text-danger"></span>
                    </div>

                    <div class="form-group mb-3">
                        <label asp-for="CategoryId" class="control-label">Category</label>
                        <select asp-for="CategoryId" class="form-control" asp-items="@(new SelectList(ViewBag.Categories, "Id", "Name"))"></select>
                    </div>
                </div>

                <!-- Products Attributes / Variants -->
                <div class="card p-4 mb-4 shadow-sm">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h4 class="mb-0">Product Variables</h4>
                        <button type="button" class="btn btn-sm btn-outline-primary" onclick="addVariant()">+ Add Variable</button>
                    </div>
                    <p class="text-muted small">Example: Size: 50ml, 100ml</p>
                    
                    <div id="variantsContainer">
                        <!-- Dynamic Variants will be rendered here -->
                    </div>
                </div>
            </div>

            <!-- Right Column: Media -->
            <div class="col-md-6">
                <!-- Image Upload -->
                <div class="card p-4 mb-4 shadow-sm">
                    <h4 class="mb-3">Main Image</h4>
                    @if (!string.IsNullOrEmpty(Model.MainImageUrl))
                    {
                        <img src="@Model.MainImageUrl" class="img-fluid mb-3 rounded" style="max-height: 200px;" />
                        <br />
                    }
                    <label>Change Image</label>
                    <input type="file" name="MainImageFile" class="form-control" accept="image/*" />
                </div>

                <!-- Video Upload (Drag & Drop) -->
                <div class="card p-4 mb-4 shadow-sm">
                    <h4 class="mb-3">Product Video (Home Page)</h4>
                    @if (!string.IsNullOrEmpty(Model.VideoUrl))
                    {
                        <div class="mb-3">
                            <video src="@Model.VideoUrl" controls style="width: 100%; max-height: 200px; border-radius: 4px;"></video>
                            <p class="small text-muted text-center mt-1">Current Video</p>
                        </div>
                    }

                    <div class="drag-drop-zone" id="videoDropZone">
                        <i class="fas fa-cloud-upload-alt fa-3x" style="color: #ccc;"></i>
                        <p class="mt-2 text-muted">Drag & Drop Video Here<br>or Click to Upload</p>
                        <input type="file" name="VideoFile" id="VideoFile" class="form-control" accept="video/*" style="display:none;" />
                        <p id="videoFileName" class="mt-2 text-success font-weight-bold"></p>
                    </div>
                </div>
            </div>
        </div>

        <div class="fixed-bottom bg-white p-3 border-top shadow text-center">
            <button type="submit" class="btn-joja-dark px-5">Save Changes</button>
            <a asp-action="Index" class="btn btn-secondary ml-3">Cancel</a>
        </div>
    </form>
</div>

@section Scripts {
    @{await Html.RenderPartialAsync("_ValidationScriptsPartial");}
    <script>
        // --- Drag & Drop for Video ---
        const dropZone = document.getElementById('videoDropZone');
        const fileInput = document.getElementById('VideoFile');
        const fileNameDisplay = document.getElementById('videoFileName');

        dropZone.addEventListener('click', () => fileInput.click());

        fileInput.addEventListener('change', () => {
             if(fileInput.files.length > 0) {
                 fileNameDisplay.textContent = "Selected: " + fileInput.files[0].name;
             }
        });

        dropZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropZone.classList.add('dragover');
        });

        dropZone.addEventListener('dragleave', () => {
            dropZone.classList.remove('dragover');
        });

        dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropZone.classList.remove('dragover');
            
            if (e.dataTransfer.files.length > 0) {
                const file = e.dataTransfer.files[0];
                if (file.type.startsWith('video/')) {
                    fileInput.files = e.dataTransfer.files;
                    fileNameDisplay.textContent = "Selected: " + file.name;
                } else {
                    alert('Please drop a video file.');
                }
            }
        });

        // --- Variants Logic ---
        let variants = [];
        try {
            const rawJson = '@Html.Raw(Model.VariantsJson ?? "[]")';
            variants = JSON.parse(rawJson);
        } catch(e) {
            console.error(e);
            variants = [];
        }

        const container = document.getElementById('variantsContainer');
        const variantsInput = document.getElementById('VariantsJson');

        function renderVariants() {
            container.innerHTML = '';
            variants.forEach((v, index) => {
                const card = document.createElement('div');
                card.className = 'variant-card';
                card.innerHTML = `
                    <div class="variant-header">
                        <strong>Variable #${index + 1}</strong>
                        <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeVariant(${index})">&times;</button>
                    </div>
                    <div class="form-group mb-2">
                        <label>Name (e.g. Size)</label>
                        <input type="text" class="form-control form-control-sm" value="${v.Name}" onchange="updateVariantName(${index}, this.value)">
                    </div>
                    <div class="form-group">
                        <label>Options (comma separated, e.g. 50ml, 100ml)</label>
                        <input type="text" class="form-control form-control-sm" value="${v.Options ? v.Options.join(', ') : ''}" onchange="updateVariantOptions(${index}, this.value)">
                    </div>
                `;
                container.appendChild(card);
            });
            updateHiddenInput();
        }

        function addVariant() {
            variants.push({ Name: "", Options: [] });
            renderVariants();
        }

        function removeVariant(index) {
            variants.splice(index, 1);
            renderVariants();
        }

        window.updateVariantName = function(index, value) {
            variants[index].Name = value;
            updateHiddenInput();
        };

        window.updateVariantOptions = function(index, value) {
            // Split by comma and trim
            variants[index].Options = value.split(',').map(s => s.trim()).filter(s => s.length > 0);
            updateHiddenInput();
        };

        function updateHiddenInput() {
            variantsInput.value = JSON.stringify(variants);
        }

        // Initial render
        renderVariants();
    </script>
}
